<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Blob 是什么？ | YangSS</title>
    <meta name="description" content="Nicholas Yang's personal blog.">
    <link rel="stylesheet" href="/yangss/assets/style.986d0184.css">
    <link rel="modulepreload" href="/yangss/assets/Home.5cd24a4a.js">
    <link rel="modulepreload" href="/yangss/assets/app.04efe956.js">
    <link rel="modulepreload" href="/yangss/assets/articles_what-is-blob.md.79550dfa.lean.js">
    <link rel="modulepreload" href="/yangss/assets/app.04efe956.js">
    <meta name="twitter:title" content="Blob 是什么？ | YangSS">
    <meta property="og:title" content="Blob 是什么？ | YangSS">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-40587210><div class="sidebar-button" data-v-40587210><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/yangss/" aria-label="YangSS, back to home" data-v-40587210 data-v-7ac13a1e><!----> YangSS</a><div class="flex-grow" data-v-40587210></div><div class="nav" data-v-40587210><nav class="nav-links" data-v-40587210 data-v-35b91e7e><!--[--><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item active" href="/yangss/articles/" data-v-49fe041d>Articles <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/yangss/notes/" data-v-49fe041d>Notes <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/yangss/projects" data-v-49fe041d>Projects <!----></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--[--><div class="flex space-x-5 ml-5"><button class="icon-button" title="Bookmarks" data-v-5dee39e6><!--[--><svg class="relative top-2px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveaspectratio="xMidYMid meet" viewbox="0 0 24 24"><path d="M17 18l-5-2.18L7 18V5h10m0-2H7a2 2 0 0 0-2 2v16l7-3l7 3V5a2 2 0 0 0-2-2z" fill="currentColor"></path></svg><!--]--></button><button class="icon-button" title="GitHub" data-v-5dee39e6><a href="https://github.com/yangss3" target="_blank" data-v-5dee39e6><!--[--><svg class="relative top-2px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveaspectratio="xMidYMid meet" viewbox="0 0 24 24"><path fill="currentColor" d="M16.24 22a1 1 0 0 1-1-1v-2.6a2.15 2.15 0 0 0-.54-1.66a1 1 0 0 1 .61-1.67C17.75 14.78 20 14 20 9.77a4 4 0 0 0-.67-2.22a2.75 2.75 0 0 1-.41-2.06a3.71 3.71 0 0 0 0-1.41a7.65 7.65 0 0 0-2.09 1.09a1 1 0 0 1-.84.15a10.15 10.15 0 0 0-5.52 0a1 1 0 0 1-.84-.15a7.4 7.4 0 0 0-2.11-1.09a3.52 3.52 0 0 0 0 1.41a2.84 2.84 0 0 1-.43 2.08a4.07 4.07 0 0 0-.67 2.23c0 3.89 1.88 4.93 4.7 5.29a1 1 0 0 1 .82.66a1 1 0 0 1-.21 1a2.06 2.06 0 0 0-.55 1.56V21a1 1 0 0 1-2 0v-.57a6 6 0 0 1-5.27-2.09a3.9 3.9 0 0 0-1.16-.88a1 1 0 1 1 .5-1.94a4.93 4.93 0 0 1 2 1.36c1 1 2 1.88 3.9 1.52a3.89 3.89 0 0 1 .23-1.58c-2.06-.52-5-2-5-7a6 6 0 0 1 1-3.33a.85.85 0 0 0 .13-.62a5.69 5.69 0 0 1 .33-3.21a1 1 0 0 1 .63-.57c.34-.1 1.56-.3 3.87 1.2a12.16 12.16 0 0 1 5.69 0c2.31-1.5 3.53-1.31 3.86-1.2a1 1 0 0 1 .63.57a5.71 5.71 0 0 1 .33 3.22a.75.75 0 0 0 .11.57a6 6 0 0 1 1 3.34c0 5.07-2.92 6.54-5 7a4.28 4.28 0 0 1 .22 1.67V21a1 1 0 0 1-.94 1z"></path></svg><!--]--></a></button><button class="icon-button" data-v-5dee39e6><!--[--><svg class="relative top-2px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveaspectratio="xMidYMid meet" viewbox="0 0 24 24" style="display:none;"><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938A7.999 7.999 0 0 0 4 12z" fill="currentColor"></path></svg><svg class="relative top-2px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveaspectratio="xMidYMid meet" viewbox="0 0 24 24" style=""><path d="M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636L5.636 7.05L3.515 4.93zM16.95 18.364l1.414-1.414l2.121 2.121l-1.414 1.414l-2.121-2.121zm2.121-14.85l1.414 1.415l-2.121 2.121l-1.414-1.414l2.121-2.121zM5.636 16.95l1.414 1.414l-2.121 2.121l-1.414-1.414l2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z" fill="currentColor"></path></svg><!--]--></button></div><!--]--><!--]--></header><aside class="sidebar" data-v-17c48e2f><nav class="nav-links nav" data-v-17c48e2f data-v-35b91e7e><!--[--><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item active" href="/yangss/articles/" data-v-49fe041d>Articles <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/yangss/notes/" data-v-49fe041d>Notes <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/yangss/projects" data-v-49fe041d>Projects <!----></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-17c48e2f><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/switch-true-pattern">妙用 switch(true)</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/yangss/articles/what-is-blob">Blob 是什么？</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#blob-转-url">Blob 转 URL</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#blob-转-base64">Blob 转 Base64</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#为-image-生成-blob">为 image 生成 Blob</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#blob-转-arraybuffer">Blob 转 ArrayBuffer</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#总结">总结</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/understand-arraybuffer">深入理解 ArrayBuffer 和 TypedArray</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/understand-weakmap-and-weakset">深入理解 WeakMap 和 WeakSet</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/understand-cors">深入理解 CORS</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/async-setup">异步 setup</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/understand-unknown-in-typescript">深入理解 TypeScript 中的 unknown</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/excess-property-checking-in-typescript">TypeScript 中的超出属性检查 (Excess property checking)</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/how-context-is-used-in-typescript">理解上下文 (Context) 在类型推断中的作用</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/understand-ts-type-system">深入理解 TypeScript 的类型系统</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/explaining-proxy-and-reflect-in-detail">详解 Proxy 和 Reflect</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/what-is-currying">什么是柯里化 (Currying)？</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/settimeout-setinterval">setTimeout 和 setInterval</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/yangss/articles/what-is-decorator-pattern">什么是装饰者模式？</a><!----></li><!--]--></ul><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-8fcebc32><div class="container" data-v-8fcebc32><!--[--><!--]--><div style="position:relative;" class="content" data-v-8fcebc32><div><h1 id="blob-是什么？" tabindex="-1">Blob 是什么？ <a class="header-anchor" href="#blob-是什么？" aria-hidden="true">#</a></h1><p class="text-gray-400 dark:text-gray-600 flex items-center space-x-2 mb-24px"><svg class="relative top-2px !top-1px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveaspectratio="xMidYMid meet" viewbox="0 0 48 48"><g fill="none" stroke="currentColor" stroke-width="4" stroke-linejoin="round"><path d="M5 19h38v21a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V19z"></path><path d="M5 9a2 2 0 0 1 2-2h34a2 2 0 0 1 2 2v10H5V9z"></path><path d="M16 4v8" stroke-linecap="round"></path><path d="M32 4v8" stroke-linecap="round"></path><path d="M28 34h6" stroke-linecap="round"></path><path d="M14 34h6" stroke-linecap="round"></path><path d="M28 26h6" stroke-linecap="round"></path><path d="M14 26h6" stroke-linecap="round"></path></g></svg><span>2021/11/22</span></p><p>前面讲到了 <code>ArrayBuffer</code> 和 <code>TypedArray</code> 等概念，它们属于 ECMA 标准，是 JavaScript 的一部分。</p><p>而在浏览器中，也有一个用于描述二进制数据的对象，即 <code>Blob</code> (Binary large object)。它是一个不可变的包含原始数据的类文件对象。<code>Blob</code> 的主要作用是方便在浏览器中进行文件操作，例如上传，下载，图片展示等等。</p><p><code>Blob</code> 主要包含两个部分，一个可选的字符串类型的 <code>type</code>（通常是 MIME-type）和一个包含 <code>ArrayBuffer</code> / <a href="https://developer.mozilla.org/en-US/docs/Web/API/ArrayBufferView" target="_blank" rel="noopener noreferrer">ArrayBufferView</a> / <code>Blob</code> / <code>String</code> 的 <code>blobParts</code>：</p><img src="/yangss/assets/blob.c24a98df.svg" class="mx-auto mt-20px mb-30px"><p>创建一个 <code>Blob</code> 的语法如下：</p><div class="language-js"><pre><code><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span>blobParts<span class="token punctuation">,</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><code>blobParts</code>：一个数组，里面可以是 <code>ArrayBuffer</code>, ArrayBufferView, <code>Blob</code>, <code>String</code>，或它们的任意组合。</li><li><code>options</code>：可选的对象 <ul><li><code>type</code>： <code>Blob</code> 中存储的数据的 MIME-type，默认值为空字符串。</li><li><code>endings</code>：是否转换行尾以使 <code>Blob</code> 对应于当前操作系统的换行(<code>\r\n</code> 或 <code>\n</code>)。默认情况下是 <code>&#39;transparent&#39;</code> (不做任何操作)，但也可以是 <code>&#39;native&#39;</code> (转换)。</li></ul></li></ul><p>例如，从 string 创建 <code>Blob</code>：</p><div class="language-js"><pre><code><span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;&lt;html&gt;...&lt;/html&gt;&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;text/html&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>从 typed array 和 string 创建 <code>Blob</code>：</p><div class="language-js"><pre><code><span class="token keyword">const</span> hello <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// &#39;Hello&#39; 的二进制形式</span>
<span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>hello<span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;world&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;text/plain&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>有一点需要注意，我们无法直接更改 <code>Blob</code> 内的数据，但可以从 <code>Blob</code> 中提取片段生成新的 <code>Blob</code>：</p><div class="language-js"><pre><code>blob<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">[</span>byteStart<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>byteEnd<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>contentType<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><code>byteStart</code>：起始字节位置，默认为 0</li><li><code>byteEnd</code>：结束字节位置 (不包含)，默认到 blob 末尾</li><li><code>contentType</code>：新的 blob 的类型, 默认与原 blob 相同</li></ul><p><code>blob.slice</code> 的用法与 <code>array.slice</code> 类似，同样支持负位置索引。</p><h2 id="blob-转-url" tabindex="-1">Blob 转 URL <a class="header-anchor" href="#blob-转-url" aria-hidden="true">#</a></h2><p>前面说到 <code>Blob</code> 为文件而生，所以可以很容易的将 <code>Blob</code> 使用于 <code>&lt;a&gt;</code>, <code>&lt;img&gt;</code> 或其它接受 url 的标签，用于展示其内容。</p><p>这正是因为 <code>Blob</code> 包含了一个 <code>type</code>，用于指定所存储的数据类型 (MIME-type)，有了这个类型，我们就可以正确的下载/上传 <code>Blob</code> 对象，也可以通过网络请求发送 <code>Blob</code>，这时 <code>type</code> 会自动成为 <code>Content-Type</code>。</p><p>看下面这个例子，用户可以通过点击链接来下载一个包含 <code>&#39;Hello, world&#39;</code> 的文本文件：</p><div class="language-html"><pre><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">download</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hello.txt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>link<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Download<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;Hello, world&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;text/plain&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#link&#39;</span><span class="token punctuation">)</span>
link<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>也可以通过 JavaScript 动态生成 link，然后通过 <code>link.click()</code> 模拟点击行为，这样无需任何 HTML，可以实现自动下载：</p><div class="language-js"><pre><code><span class="token keyword">const</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span>

link<span class="token punctuation">.</span>download <span class="token operator">=</span> <span class="token string">&#39;hello.txt&#39;</span>

<span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;Hello, world&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;text/plain&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

link<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>

link<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span>href<span class="token punctuation">)</span>
</code></pre></div><p>这里用到了 <code>URL.createObjectURL</code> 和 <code>URL.revokeObjectURL</code> 两个浏览器内置方法。</p><p><code>URL.createObjectURL</code> 接收一个 <code>Blob</code> 对象，并为它生成一个唯一的 URL (<code>blob:&lt;origin&gt;/&lt;uuid&gt;</code>)。</p><p>对每个 <code>URL.createObjectURL</code> 生成的 URL，浏览器会在内部存储一个 URL -&gt; Blob 的映射。这样可以通过很简短的 URL 就能访问到 <code>Blob</code>。而且该 URL 只在当前打开的文档中有效，即作用域为当前 session。</p><p>但同时这也有一个副作用。由于存在 URL -&gt; Blob 映射， <code>Blob</code> 本身会驻留在内存中。除非页面被卸载，否则浏览器无法自动释放它。这可能不是我们想要的。</p><p>通过调用 <code>URL.revokeObjectURL(url)</code> 可以从内部映射中删除对 <code>Blob</code> 的引用，如果 <code>Blob</code> 没有其它引用，它将会被清除，并释放内存。</p><p>在上面自动下载的例子中，因为只需要下载一次，所以后面立刻调用了 <code>URL.revokeObjectURL</code> 来释放内存。但在手动点击链接进行下载的例子中，我们希望可以多次下载，所以没有调用 <code>URL.revokeObjectURL</code>，如果这样做，链接上的 <code>Blob</code> url 将会失效，因为它们之间的映射关系已经被移除了。</p><h2 id="blob-转-base64" tabindex="-1">Blob 转 Base64 <a class="header-anchor" href="#blob-转-base64" aria-hidden="true">#</a></h2><p>除了可以通过 <code>URL.createObjectURL</code> 生成 <code>Blob</code> url 外，还可以将 <code>Blob</code> 转换成 base64 编码的字符串。</p><p>这种编码方式将二进制数据表示为一串安全的“可读”字符。更重要的是，我们可以在 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URIs" target="_blank" rel="noopener noreferrer">Data URL</a> 中使用这种编码。</p><p>一个 Data URL 具有这样的形式：<code>data:[&lt;mediatype&gt;][;base64],&lt;data&gt;</code>。我们可以在任何地方使用这样的 url，就像常规 url 一样。例如</p><div class="language-html"><pre><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>data:image/png;base64,R0lGODlhDAAMAKIFAF5LAP/zxAAAANyuAP/gaP///wAAAAAAACH5BAEAAAUALAAAAAAMAAwAAAMlWLPcGjDKFYi9lxKBOaGcF35DhWHamZUW0K4mAbiwWtuf0uxFAgA7<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>浏览器会解码这个字符串并展示这张图片<img class="inline-block ml-1" src="data:image/png;base64,R0lGODlhDAAMAKIFAF5LAP/zxAAAANyuAP/gaP///wAAAAAAACH5BAEAAAUALAAAAAAMAAwAAAMlWLPcGjDKFYi9lxKBOaGcF35DhWHamZUW0K4mAbiwWtuf0uxFAgA7">。</p><p>要将 <code>Blob</code> 转换成 base64，可以使用浏览器内置的 <a href="https://developer.mozilla.org/en-US/docs/Web/API/FileReader" target="_blank" rel="noopener noreferrer"><code>FileReader</code> API</a>，它能以多种不同的格式从 <code>Blob</code> 种读取数据。</p><p>下面是使用 base64 的形式下载 <code>Blob</code> 的例子：</p><div class="language-js"><pre><code><span class="token keyword">const</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span>

link<span class="token punctuation">.</span>download <span class="token operator">=</span> <span class="token string">&#39;hello.txt&#39;</span>

<span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;Hello, world!&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;text/plain&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span> <span class="token comment">// 以 base64 的格式从 blob 中读取数据</span>

reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  link<span class="token punctuation">.</span>href <span class="token operator">=</span> reader<span class="token punctuation">.</span>result <span class="token comment">// data url</span>
  link<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这两种创建 <code>Blob</code> URL 的方法都是可行的。但通常 <code>URL.createObjectURL(blob)</code> 更简单而且速度更快。两者对比如下：</p><table><thead><tr><th>URL.createObjectURL(blob)</th><th>Blob to data url</th></tr></thead><tbody><tr><td>如果对内存泄露比较在意，需要手动 revoke 进行清理</td><td>无内存泄漏问题，无需手动清理</td></tr><tr><td>直接访问 <code>Blob</code>，没有 encoding / decoding 过程</td><td>需要进行 base64 编码，当 <code>Blob</code> 很大时，会有性能问题，而且会占用更大的内存空间</td></tr></tbody></table><h2 id="为-image-生成-blob" tabindex="-1">为 image 生成 Blob <a class="header-anchor" href="#为-image-生成-blob" aria-hidden="true">#</a></h2><p>也可以为图片生成 <code>Blob</code>，然后进行上传和下载等等。</p><p>对图片的操作可以借助 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial" target="_blank" rel="noopener noreferrer"><code>canvas</code></a> 元素实现</p><ul><li>使用 <a href="https://developer.mozilla.org/en-US/docs/Web/api/CanvasRenderingContext2D/drawImage" target="_blank" rel="noopener noreferrer"><code>canvas.drawImage</code></a> 将图片画在 canvas 画布上。</li><li>调用 <a href="https://developer.mozilla.org/en-US/docs/Web/api/HTMLCanvasElement/toBlob" target="_blank" rel="noopener noreferrer"><code>.toBlob(callback, type, quality)</code></a> 获取 <code>Blob</code>，等待完成后会执行 <code>callback</code> 回调。</li></ul><div class="language-js"><pre><code><span class="token comment">// 获取图片元素</span>
<span class="token keyword">const</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;img&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个相同尺寸的画布</span>
<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;canvas&#39;</span><span class="token punctuation">)</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> img<span class="token punctuation">.</span>clientWidth
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> img<span class="token punctuation">.</span>clientHeight

<span class="token keyword">const</span> context <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;2d&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// 复制图片到画布 (还可能通过这个方法对图片进行裁剪)</span>
context<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// toBlob 是异步操作, callback 会在完成后执行</span>
canvas<span class="token punctuation">.</span><span class="token function">toBlob</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">blob</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 拿到 blob，进行下载</span>
  <span class="token keyword">const</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span>
  link<span class="token punctuation">.</span>download <span class="token operator">=</span> <span class="token string">&#39;example.png&#39;</span>

  link<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
  link<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 删除内部 blob 引用, 让浏览器释放内存</span>
  <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span>href<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;image/png&#39;</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="blob-转-arraybuffer" tabindex="-1">Blob 转 ArrayBuffer <a class="header-anchor" href="#blob-转-arraybuffer" aria-hidden="true">#</a></h2><p>我们可以使用 <code>Blob()</code> 构造函数从几乎任何东西创建一个 blob，包括 <code>ArrayBuffer</code> 和所有 <code>ArrayBufferView</code>。</p><p>但如果我们要行进 low-level 的操作，可以使用 <code>FileReader</code> 获取 <code>Blob</code> 最底层的 <code>ArrayBuffer</code>：</p><div class="language-js"><pre><code><span class="token comment">// 从 Blob 获取 ArrayBuffer</span>
<span class="token keyword">const</span> fileReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

fileReader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>

fileReader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> arrayBuffer <span class="token operator">=</span> fileReader<span class="token punctuation">.</span>result
<span class="token punctuation">}</span>
</code></pre></div><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-hidden="true">#</a></h2><ul><li><code>ArrayBuffer</code>, <code>Uint8Array </code> 等等其它 <code>ArrayBufferView</code> 都属于二进制数据，而 <code>Blob</code> 代表的是有类型 (type) 的二进制数据。</li><li>因为 <code>Blob</code> 具有类型，这使得它可以方便地进行上传/下载操作，这些操作在浏览器中非常常见。</li><li><code>XMLHttpRequest</code>, <code>fetch</code> web请求原生地支持 Blob 类型。</li><li><code>Blob</code> 和 low-level 的二进制数据类型可以进行相互转换。</li></ul></div></div><footer class="page-footer" data-v-8fcebc32 data-v-5c96fb00><div class="edit" data-v-5c96fb00><div class="edit-link" data-v-5c96fb00 data-v-55695e90><!----></div></div><div class="updated" data-v-5c96fb00><!----></div></footer><div class="next-and-prev-link" data-v-8fcebc32 data-v-e65a9748><div class="container" data-v-e65a9748><div class="prev" data-v-e65a9748><a class="link" href="/yangss/articles/switch-true-pattern" data-v-e65a9748><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-e65a9748><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-e65a9748>妙用 switch(true)</span></a></div><div class="next" data-v-e65a9748><a class="link" href="/yangss/articles/understand-arraybuffer" data-v-e65a9748><span class="text" data-v-e65a9748>深入理解 ArrayBuffer 和 TypedArray</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-e65a9748><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"readme.md\":\"415706a0\",\"articles_async-setup.md\":\"20d95dd7\",\"articles_excess-property-checking-in-typescript.md\":\"558c369e\",\"articles_explaining-proxy-and-reflect-in-detail.md\":\"dbd0b8fc\",\"articles_how-context-is-used-in-typescript.md\":\"bc43d58e\",\"articles_index.md\":\"da255f86\",\"articles_settimeout-setinterval.md\":\"251a5307\",\"articles_switch-true-pattern.md\":\"3a94462e\",\"articles_understand-arraybuffer.md\":\"b7dd3054\",\"articles_understand-cors.md\":\"2590d5a3\",\"articles_understand-ts-type-system.md\":\"a4d5fdfd\",\"articles_understand-unknown-in-typescript.md\":\"ceed3393\",\"articles_understand-weakmap-and-weakset.md\":\"ad3eabea\",\"articles_what-is-blob.md\":\"79550dfa\",\"articles_what-is-currying.md\":\"03c96736\",\"articles_what-is-decorator-pattern.md\":\"71d8c1a1\",\"bookmarks.md\":\"57168278\",\"index.md\":\"d0d03762\",\"notes_git.md\":\"1f226f5e\",\"notes_index.md\":\"3f328f92\",\"notes_linux.md\":\"a7fbcfd5\",\"notes_nginx.md\":\"20f9d9cc\",\"notes_package-json.md\":\"7515ba0b\",\"notes_regexp.md\":\"90464ba9\",\"notes_type-challenges.md\":\"b93d6e2d\",\"notes_typescript.md\":\"cfc87439\",\"projects.md\":\"0024e011\"}")</script>
    <script type="module" async src="/yangss/assets/app.04efe956.js"></script>
    
  </body>
</html>